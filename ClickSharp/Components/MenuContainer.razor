@inherits MenuBase
@using ClickSharp.Models.Data
@using ClickSharp.Components
@using System.Linq
@using ClickSharp.Helpers
@inject ClickSharpContext dbContext

<style>
    .dropdown:hover .dropdown-menu {
        display: block;
        margin-top: 0; /* remove the gap so it doesn't close */
    }
</style>

<nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Navbar</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul ondragover="event.preventDefault()" draggable="false" class="navbar-nav me-auto mb-2 mb-lg-0">
                @if (items.Count > 0)
                {
                    string isActive;
                    isActive = (IsActive == 0) ? "bg-success" : "";
                    <li ondragover="event.preventDefault()" @ondragenter="()=>OnDragEnter(0)" @ondragleave=OnDragLeave @ondrop="()=>OnDrop(1)"
                    class="text-white @isActive" style="width:10px;">
                        &nbsp;
                    </li>
                    @for (int i = 0; i < items.Count; i++)
                    {
                        <MenuItem MenuData="@items[i]" @bind-Item=_item />
                        var currentIndex = i + 2;
                        isActive = (IsActive == currentIndex) ? "bg-success" : "";
                        <li ondragover="event.preventDefault()" @ondragenter="()=>OnDragEnter(currentIndex)" @ondragleave=OnDragLeave @ondrop="()=>OnDrop(currentIndex)"
                    class="text-white @isActive" style="width:10px;">&nbsp;</li>
                    }
                }
                else
                {
                    <li ondragover="event.preventDefault()" draggable="false" style="width:100%; height:30px" @ondrop="()=>OnDrop(1)">
                        &nbsp;
                    </li>
                }
            </ul>
        </div>
    </div>
</nav>


@foreach (var element in elementsToDrag)
{
    <ClickSharp.Components.MenuItem @bind-Item=_item MenuData="element" />
}

<div @ondrop=DropBack style="width:290px;height:30px;" class="bg-danger text-center" ondragover="event.preventDefault()">
    drop here to exclude from menu
</div>
<div @ondrop=DeleteItem style="width:290px;height:30px;" class="bg-warning text-center" ondragover="event.preventDefault()">
    drop here to delete item
</div>

@code {
    private void DropBack()
    {
        if (_item != null)
        {
            Menu? dbMenuItem = dbContext?.Menu?.FirstOrDefault(x => x.Id == _item.Id);
            if (dbMenuItem != null)
            {
                dbMenuItem.Index = 0;
                dbMenuItem.ParentId = null;
                items.Remove(_item);
                for (int i = 0; i < items.Count; i++)
                {
                    Menu? dbItem = dbContext?.Menu?.FirstOrDefault(x => x.Id == items[i].Id);
                    if (dbItem != null)
                    {
                        dbItem.Index = i;
                    }
                }
                dbContext?.SaveChanges();
                _item = null;
                IsActive = null;
                StateHasChanged();
            }
        }
    }
    private async void DeleteItem()
    {
        if (_item != null)
        {
            Menu? dbMenuItem = dbContext?.Menu?.FirstOrDefault(x => x.Id == _item.Id);
            if (dbMenuItem != null)
            {
                dbContext?.Menu?.Remove(dbMenuItem);
                await dbContext?.SaveChangesAsync();
                _item = null;
                IsActive = null;
                StateHasChanged();
            }
        }
    }

    protected override void OnInitialized()
    {
        elementsToDrag.Clear();
    //    items.Add(new MenuModel
    //        {
    //            Id = 0,
    //            Index = 1,
    //            DisplayName = "one"
    //        });
    //    items.Add(
    //new MenuModel
    //    {
    //        Id = 1,
    //        Index = 2,
    //        DisplayName = "two"
    //    });
    //    items.Add(
    //    new MenuModel
    //        {
    //            Id = 2,
    //            Index = 3,
    //            DisplayName = "three"
    //        });


        if (dbContext.Menu != null)
        {
            List<Menu> menu = dbContext.Menu.OrderBy(x => x.Index).ToList();

            foreach (var item in menu)
            {
                if (item.Index == 0)
                {
                    elementsToDrag.Add(
                        new MenuModel
                            {
                                Id = item.Id,
                                Index = item.Index,
                                DisplayName = item.DisplayName,
                                PageId = item.PageId,
                                ParentId = item.ParentId
                            }
                    );
                }
                else
                {
                    items.Add(
                    new MenuModel
                        {
                            Id = item.Id,
                            Index = item.Index,
                            DisplayName = item.DisplayName,
                            PageId = item.PageId,
                            ParentId = item.ParentId
                        });
                }
            }
        }

        base.OnInitialized();
    }
}
